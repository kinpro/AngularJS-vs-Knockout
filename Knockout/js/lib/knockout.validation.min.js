(function(factory){if(typeof require==="function"&&typeof exports==="object"&&typeof module==="object"){factory(require("knockout"),exports)}else{if(typeof define==="function"&&define.amd){define(["knockout","exports"],factory)}else{factory(ko,ko.validation={})}}}(function(ko,exports){if(typeof(ko)===undefined){throw"Knockout is required, please ensure it is loaded before loading this validation plug-in"}var validation=exports;ko.validation=validation;var defaults={registerExtenders:true,messagesOnModified:true,errorsAsTitle:true,errorsAsTitleOnModified:false,messageTemplate:null,insertMessages:true,parseInputAttributes:false,writeInputAttributes:false,decorateElement:false,decorateElementOnModified:true,errorClass:null,errorElementClass:"validationElement",errorMessageClass:"validationMessage",grouping:{deep:false,observable:true}};var configuration=ko.utils.extend({},defaults);var html5Attributes=["required","pattern","min","max","step"];var html5InputTypes=["email","number","date"];var async=function(expr){if(window.setImmediate){window.setImmediate(expr)}else{window.setTimeout(expr,0)}};var utils=(function(){var seedId=new Date().getTime();var domData={};var domDataKey="__ko_validation__";return{isArray:function(o){return o.isArray||Object.prototype.toString.call(o)==="[object Array]"},isObject:function(o){return o!==null&&typeof o==="object"},values:function(o){var r=[];for(var i in o){if(o.hasOwnProperty(i)){r.push(o[i])}}return r},getValue:function(o){return(typeof o==="function"?o():o)},hasAttribute:function(node,attr){return node.getAttribute(attr)!==null},getAttribute:function(element,attr){return element.getAttribute(attr)},setAttribute:function(element,attr,value){return element.setAttribute(attr,value)},isValidatable:function(o){return o&&o.rules&&o.isValid&&o.isModified},insertAfter:function(node,newNode){node.parentNode.insertBefore(newNode,node.nextSibling)},newId:function(){return seedId+=1},getConfigOptions:function(element){var options=utils.contextFor(element);return options||configuration},setDomData:function(node,data){var key=node[domDataKey];if(!key){node[domDataKey]=key=utils.newId()}domData[key]=data},getDomData:function(node){var key=node[domDataKey];if(!key){return undefined}return domData[key]},contextFor:function(node){switch(node.nodeType){case 1:case 8:var context=utils.getDomData(node);if(context){return context}if(node.parentNode){return utils.contextFor(node.parentNode)}break}return undefined},isEmptyVal:function(val){if(val===undefined){return true}if(val===null){return true}if(val===""){return true}},getOriginalElementTitle:function(element){var savedOriginalTitle=utils.getAttribute(element,"data-orig-title"),currentTitle=element.title,hasSavedOriginalTitle=utils.hasAttribute(element,"data-orig-title");return hasSavedOriginalTitle?savedOriginalTitle:currentTitle}}}());var api=(function(){var isInitialized=0;return{utils:utils,init:function(options,force){if(isInitialized>0&&!force){return}options=options||{};options.errorElementClass=options.errorElementClass||options.errorClass||configuration.errorElementClass;options.errorMessageClass=options.errorMessageClass||options.errorClass||configuration.errorMessageClass;ko.utils.extend(configuration,options);if(configuration.registerExtenders){exports.registerExtenders()}isInitialized=1},configure:function(options){exports.init(options)},reset:function(){ko.utils.extend(configuration,defaults)},group:function group(obj,options){options=ko.utils.extend(ko.utils.extend({},configuration.grouping),options);var validatables=ko.observableArray([]),result=null,traverse=function traverse(obj,level){var objValues=[],val=ko.utils.unwrapObservable(obj);level=(level!==undefined?level:options.deep?1:-1);if(ko.isObservable(obj)){if(!obj.isValid){obj.extend({validatable:true})}validatables.push(obj)}if(val){if(utils.isArray(val)){objValues=val}else{if(utils.isObject(val)){objValues=utils.values(val)}}}if(level!==0){ko.utils.arrayForEach(objValues,function(observable){if(observable&&!observable.nodeType){traverse(observable,level+1)}})}};if(options.observable){traverse(obj);result=ko.computed(function(){var errors=[];ko.utils.arrayForEach(validatables(),function(observable){if(!observable.isValid()){errors.push(observable.error)}});return errors})}else{result=function(){var errors=[];validatables([]);traverse(obj);ko.utils.arrayForEach(validatables(),function(observable){if(!observable.isValid()){errors.push(observable.error)}});return errors}}result.showAllMessages=function(show){if(show===undefined){show=true}result();ko.utils.arrayForEach(validatables(),function(observable){observable.isModified(show)})};obj.errors=result;obj.isValid=function(){return obj.errors().length===0};obj.isAnyMessageShown=function(){var invalidAndModifiedPresent=false;result();ko.utils.arrayForEach(validatables(),function(observable){if(!observable.isValid()&&observable.isModified()){invalidAndModifiedPresent=true}});return invalidAndModifiedPresent};return result},formatMessage:function(message,params){if(typeof(message)==="function"){return message(params)}return message.replace(/\{0\}/gi,ko.utils.unwrapObservable(params))},addRule:function(observable,rule){observable.extend({validatable:true});observable.rules.push(rule);return observable},addAnonymousRule:function(observable,ruleObj){var ruleName=utils.newId();if(ruleObj.message===undefined){ruleObj.message="Error"}exports.rules[ruleName]=ruleObj;exports.addRule(observable,{rule:ruleName,params:ruleObj.params})},addExtender:function(ruleName){ko.extenders[ruleName]=function(observable,params){if(params.message||params.onlyIf){return exports.addRule(observable,{rule:ruleName,message:params.message,params:utils.isEmptyVal(params.params)?true:params.params,condition:params.onlyIf})}else{return exports.addRule(observable,{rule:ruleName,params:params})}}},registerExtenders:function(){if(configuration.registerExtenders){for(var ruleName in exports.rules){if(exports.rules.hasOwnProperty(ruleName)){if(!ko.extenders[ruleName]){exports.addExtender(ruleName)}}}}},insertValidationMessage:function(element){var span=document.createElement("SPAN");span.className=utils.getConfigOptions(element).errorMessageClass;utils.insertAfter(element,span);return span},parseInputValidationAttributes:function(element,valueAccessor){ko.utils.arrayForEach(html5Attributes,function(attr){if(utils.hasAttribute(element,attr)){exports.addRule(valueAccessor(),{rule:attr,params:element.getAttribute(attr)||true})}});var currentType=element.getAttribute("type");ko.utils.arrayForEach(html5InputTypes,function(type){if(type===currentType){exports.addRule(valueAccessor(),{rule:(type==="date")?"dateISO":type,params:true})}})},writeInputValidationAttributes:function(element,valueAccessor){var observable=valueAccessor();if(!observable||!observable.rules){return}var contexts=observable.rules();ko.utils.arrayForEach(html5Attributes,function(attr){var params;var ctx=ko.utils.arrayFirst(contexts,function(ctx){return ctx.rule.toLowerCase()===attr.toLowerCase()});if(!ctx){return}params=ctx.params;if(ctx.rule==="pattern"){if(ctx.params instanceof RegExp){params=ctx.params.source}}element.setAttribute(attr,params)});contexts=null},makeBindingHandlerValidatable:function(handlerName){var init=ko.bindingHandlers[handlerName].init;ko.bindingHandlers[handlerName].init=function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){init(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext);return ko.bindingHandlers.validationCore.init(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext)}}}}());ko.utils.extend(validation,api);validation.rules={};validation.rules.required={validator:function(val,required){var stringTrimRegEx=/^\s+|\s+$/g,testVal;if(val===undefined||val===null){return !required}testVal=val;if(typeof(val)==="string"){testVal=val.replace(stringTrimRegEx,"")}if(!required){return true}return((testVal+"").length>0)},message:"This field is required."};validation.rules.min={validator:function(val,min){return utils.isEmptyVal(val)||val>=min},message:"Please enter a value greater than or equal to {0}."};validation.rules.max={validator:function(val,max){return utils.isEmptyVal(val)||val<=max},message:"Please enter a value less than or equal to {0}."};validation.rules.minLength={validator:function(val,minLength){return utils.isEmptyVal(val)||val.length>=minLength},message:"Please enter at least {0} characters."};validation.rules.maxLength={validator:function(val,maxLength){return utils.isEmptyVal(val)||val.length<=maxLength},message:"Please enter no more than {0} characters."};validation.rules.pattern={validator:function(val,regex){return utils.isEmptyVal(val)||val.toString().match(regex)!==null},message:"Please check this value."};validation.rules.step={validator:function(val,step){if(utils.isEmptyVal(val)||step=="any"){return true}var dif=(val*100)%(step*100);return Math.abs(dif)<0.00001||Math.abs(1-dif)<0.00001},message:"The value must increment by {0}"};validation.rules.email={validator:function(val,validate){if(!validate){return true}return utils.isEmptyVal(val)||(validate&&/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i.test(val))},message:"Please enter a proper email address"};validation.rules.date={validator:function(value,validate){if(!validate){return true}return utils.isEmptyVal(value)||(validate&&!/Invalid|NaN/.test(new Date(value)))},message:"Please enter a proper date"};validation.rules.dateISO={validator:function(value,validate){if(!validate){return true}return utils.isEmptyVal(value)||(validate&&/^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/.test(value))},message:"Please enter a proper date"};validation.rules.number={validator:function(value,validate){if(!validate){return true}return utils.isEmptyVal(value)||(validate&&/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test(value))},message:"Please enter a number"};validation.rules.digit={validator:function(value,validate){if(!validate){return true}return utils.isEmptyVal(value)||(validate&&/^\d+$/.test(value))},message:"Please enter a digit"};validation.rules.phoneUS={validator:function(phoneNumber,validate){if(!validate){return true}if(typeof(phoneNumber)!=="string"){return false}if(utils.isEmptyVal(phoneNumber)){return true}phoneNumber=phoneNumber.replace(/\s+/g,"");return validate&&phoneNumber.length>9&&phoneNumber.match(/^(1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/)},message:"Please specify a valid phone number"};validation.rules.equal={validator:function(val,params){var otherValue=params;return val===utils.getValue(otherValue)},message:"Values must equal"};validation.rules.notEqual={validator:function(val,params){var otherValue=params;return val!==utils.getValue(otherValue)},message:"Please choose another value."};validation.rules.unique={validator:function(val,options){var c=utils.getValue(options.collection),external=utils.getValue(options.externalValue),counter=0;if(!val||!c){return true}ko.utils.arrayFilter(ko.utils.unwrapObservable(c),function(item){if(val===(options.valueAccessor?options.valueAccessor(item):item)){counter++}});return counter<(external!==undefined&&val!==external?1:2)},message:"Please make sure the value is unique."};(function(){validation.registerExtenders()}());ko.bindingHandlers.validationCore=(function(){return{init:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var config=utils.getConfigOptions(element);if(config.parseInputAttributes){async(function(){exports.parseInputValidationAttributes(element,valueAccessor)})}if(config.insertMessages&&utils.isValidatable(valueAccessor())){var validationMessageElement=exports.insertValidationMessage(element);if(config.messageTemplate){ko.renderTemplate(config.messageTemplate,{field:valueAccessor()},null,validationMessageElement,"replaceNode")}else{ko.applyBindingsToNode(validationMessageElement,{validationMessage:valueAccessor()})}}if(config.writeInputAttributes&&utils.isValidatable(valueAccessor())){exports.writeInputValidationAttributes(element,valueAccessor)}if(config.decorateElement&&utils.isValidatable(valueAccessor())){ko.applyBindingsToNode(element,{validationElement:valueAccessor()})}},update:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){}}}());api.makeBindingHandlerValidatable("value");api.makeBindingHandlerValidatable("checked");ko.bindingHandlers.validationMessage={update:function(element,valueAccessor){var obsv=valueAccessor(),config=utils.getConfigOptions(element),val=ko.utils.unwrapObservable(obsv),msg=null,isModified=false,isValid=false;obsv.extend({validatable:true});isModified=obsv.isModified();isValid=obsv.isValid();var errorMsgAccessor=function(){if(!config.messagesOnModified||isModified){return isValid?null:obsv.error}else{return null}};var visiblityAccessor=function(){return(!config.messagesOnModified||isModified)?!isValid:false};ko.bindingHandlers.text.update(element,errorMsgAccessor);ko.bindingHandlers.visible.update(element,visiblityAccessor)}};ko.bindingHandlers.validationElement={update:function(element,valueAccessor){var obsv=valueAccessor(),config=utils.getConfigOptions(element),val=ko.utils.unwrapObservable(obsv),msg=null,isModified=false,isValid=false;obsv.extend({validatable:true});isModified=obsv.isModified();isValid=obsv.isValid();var cssSettingsAccessor=function(){var css={};var shouldShow=((!config.decorateElementOnModified||isModified)?!isValid:false);if(!config.decorateElement){shouldShow=false}css[config.errorElementClass]=shouldShow;return css};ko.bindingHandlers.css.update(element,cssSettingsAccessor);if(!config.errorsAsTitle){return}var origTitle=utils.getAttribute(element,"data-orig-title"),elementTitle=element.title,titleIsErrorMsg=utils.getAttribute(element,"data-orig-title")==="true";var errorMsgTitleAccessor=function(){if(!config.errorsAsTitleOnModified||isModified){if(!isValid){return{title:obsv.error,"data-orig-title":utils.getOriginalElementTitle(element)}}else{return{title:utils.getOriginalElementTitle(element),"data-orig-title":null}}}};ko.bindingHandlers.attr.update(element,errorMsgTitleAccessor)}};ko.bindingHandlers.validationOptions=(function(){return{init:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var options=ko.utils.unwrapObservable(valueAccessor());if(options){var newConfig=ko.utils.extend({},configuration);ko.utils.extend(newConfig,options);utils.setDomData(element,newConfig)}}}}());ko.extenders.validation=function(observable,rules){ko.utils.arrayForEach(utils.isArray(rules)?rules:[rules],function(rule){exports.addAnonymousRule(observable,rule)});return observable};ko.extenders.validatable=function(observable,enable){if(enable&&!utils.isValidatable(observable)){observable.error=ko.observable(null);observable.rules=ko.observableArray();observable.isValidating=ko.observable(false);observable.__valid__=ko.observable(true);observable.isModified=ko.observable(false);var h_obsValidationTrigger=ko.computed(function(){var obs=observable(),ruleContexts=observable.rules();exports.validateObservable(observable);return true});observable.isValid=ko.computed(function(){return observable.__valid__()});observable.setError=function(error){observable.error(error);observable.__valid__(false)};observable.clearError=function(){observable.error(null);observable.__valid__(true)};var h_change=observable.subscribe(function(){observable.isModified(true)});observable._disposeValidation=function(){observable.isValid.dispose();observable.rules.removeAll();observable.isModified._subscriptions.change=[];observable.isValidating._subscriptions.change=[];observable.__valid__._subscriptions.change=[];h_change.dispose();h_obsValidationTrigger.dispose();delete observable.rules;delete observable.error;delete observable.isValid;delete observable.isValidating;delete observable.__valid__;delete observable.isModified}}else{if(enable===false&&utils.isValidatable(observable)){if(observable._disposeValidation){observable._disposeValidation()}}}return observable};function validateSync(observable,rule,ctx){if(!rule.validator(observable(),ctx.params===undefined?true:ctx.params)){observable.error(exports.formatMessage(ctx.message||rule.message,ctx.params));observable.__valid__(false);return false}else{return true}}function validateAsync(observable,rule,ctx){observable.isValidating(true);var callBack=function(valObj){var isValid=false,msg="";if(!observable.__valid__()){observable.isValidating(false);return}if(valObj.message){isValid=valObj.isValid;msg=valObj.message}else{isValid=valObj}if(!isValid){observable.error(exports.formatMessage(msg||ctx.message||rule.message,ctx.params));observable.__valid__(isValid)}observable.isValidating(false)};rule.validator(observable(),ctx.params||true,callBack)}validation.validateObservable=function(observable){var i=0,rule,ctx,ruleContexts=observable.rules(),len=ruleContexts.length;for(;i<len;i++){ctx=ruleContexts[i];if(ctx.condition&&!ctx.condition()){continue}rule=exports.rules[ctx.rule];if(rule.async||ctx.async){validateAsync(observable,rule,ctx)}else{if(!validateSync(observable,rule,ctx)){return false}}}observable.error(null);observable.__valid__(true);return true};ko.validatedObservable=function(initialValue){if(!exports.utils.isObject(initialValue)){return ko.observable(initialValue).extend({validatable:true})}var obsv=ko.observable(initialValue);obsv.errors=exports.group(initialValue);obsv.isValid=ko.computed(function(){return obsv.errors().length===0});return obsv};validation.localize=function(msgTranslations){var msg,rule;for(rule in msgTranslations){if(exports.rules.hasOwnProperty(rule)){exports.rules[rule].message=msgTranslations[rule]}}};ko.applyBindingsWithValidation=function(viewModel,rootNode,options){var len=arguments.length,node,config;if(len>2){node=rootNode;config=options}else{if(len<2){node=document.body}else{if(arguments[1].nodeType){node=rootNode}else{config=arguments[1]}}}exports.init();if(config){exports.utils.setDomData(node,config)}ko.applyBindings(viewModel,rootNode)};var origApplyBindings=ko.applyBindings;ko.applyBindings=function(viewModel,rootNode){exports.init();origApplyBindings(viewModel,rootNode)}}));